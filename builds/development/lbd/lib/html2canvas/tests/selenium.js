!function(){"use strict;";function e(e){return new u(function(r){var t=n.decode(e);new o(t).decodePixels(r)})}function r(e,r){for(var t=e.length,n=0,o=0;n<t;n++)r[n]-e[n]!=0&&o++;return 100-Math.round(o/e.length*1e4)/100}function t(n,o,s){return s=s||0,function(t,n){return u.resolve(t.then(a.loadTestPage(t,n,l)).then(function(e){return function(){return u.props({dataUrl:e.waitForElementByCss(".html2canvas",15e3).then(function(r){return e.execute("return arguments[0].toDataURL('image/png').substring(22)",[r])}),screenshot:e.takeScreenshot()})}}(t)).then(function(t){return function(n){return u.all([e(n.dataUrl),e(n.screenshot)]).spread(r).then(function(e){return{testCase:t,accuracy:e,dataUrl:n.dataUrl,screenshot:n.screenshot}})}}(n))).cancellable()}(n,o).timeout(6e4).catch(u.TimeoutError,function(){if(s<3)return console.log(i.violet,"Retry",s+1,o),t(n,o,s+1);throw new Error("Couldn't run test after 3 retries")})}require("wd"),require("http"),require("https"),require("url"),require("path");var n=require("base64-arraybuffer"),o=require("png-js"),u=require("bluebird"),s=(require("lodash"),require("humanize-duration")),c=require("fs"),a=require("./utils"),i=a.colors;u.promisifyAll(c);var l=8080;exports.tests=function(e,r){return(r?u.resolve([r]):a.getTests("tests/cases")).then(function(r){return u.map(e,function(e){var n=a.initBrowser(e),o=[e.browserName,e.version,e.platform].join("-"),c=0;return u.using(n,function(){return u.map(r,function(e,r,u){console.log(i.green,"STARTING","("+ ++c+"/"+u+")",o,e,i.clear);var a=Date.now();return t(n,e).then(function(e){console.log(i.green,"COMPLETE",s(Date.now()-a),"("+c+"/"+u+")",o,e.testCase.substring("tests/cases".length),e.accuracy.toFixed(2)+"%",i.clear)})},{concurrency:1}).settle().catch(function(e){throw console.log(i.red,"ERROR",o,e.message),e})})},{concurrency:3})})}}();