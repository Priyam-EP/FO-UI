!function(e){e.fn.tagedit=function(t){function i(i){if(0!=t.allowEdit){var s="SPAN"==i.target.tagName?e(i.target).parent():e(i.target),l=null;s.bind("finishEdit",function(t,i){window.clearTimeout(l);var a=e(this).find(":text"),s=n(a.val(),!0);return a.val().length>0&&(void 0===i||!1===i)&&1==s[0]&&(e(this).find(":hidden").val(a.val()),e(this).find("span").html(a.val())),a.remove(),e(this).find("a.tagedit-save, a.tagedit-break, a.tagedit-delete").remove(),e(this).removeClass("tagedit-listelement-edit").unbind("finishEdit"),!1});var o=s.find(":hidden");html='<input type="text" name="tmpinput" autocomplete="off" value="'+o.val()+'" class="tagedit-edit-input" dir="'+t.direction+'"/>',html+='<a class="tagedit-save" title="'+t.texts.saveEditLinkTitle+'">o</a>',html+='<a class="tagedit-break" title="'+t.texts.breakEditLinkTitle+'">x</a>',1==t.allowDelete&&s.find(":hidden").length>0&&void 0!==s.find(":hidden").attr("name").match(r)[3]&&(html+='<a class="tagedit-delete" title="'+t.texts.deleteLinkTitle+'">d</a>'),o.after(html),s.addClass("tagedit-listelement-edit").find("a.tagedit-save").click(function(){return e(this).parent().trigger("finishEdit"),!1}).end().find("a.tagedit-break").click(function(){return e(this).parent().trigger("finishEdit",[!0]),!1}).end().find("a.tagedit-delete").click(function(){if(window.clearTimeout(l),confirm(t.texts.deleteConfirmation)){var i=function(i){if(null===t.checkToDeleteURL)return!1;var a=i.find("input:hidden").attr("name"),n=new RegExp("\\d"),s=a.match(n),l=!1;return e.ajax({async:!1,url:t.checkToDeleteURL,dataType:"json",type:"POST",data:{tagId:s},complete:function(t,i){var a=e.parseJSON(t.responseText);!0===a.success&&(l=a.allowDelete)}}),l}(e(this).parent());!i&&confirm(t.texts.forceDeleteConfirmation)&&a(e(this).parent()),i&&a(e(this).parent()),e(this).parent().find(":text").trigger("finishEdit",[!0])}else e(this).parent().find(":text").trigger("finishEdit",[!0]);return!1}).end().find(":text").focus().autoGrowInput({comfortZone:10,minWidth:15,maxWidth:2e4}).keypress(function(t){switch(t.keyCode){case 13:return t.preventDefault(),e(this).parent().trigger("finishEdit"),!1;case 27:return t.preventDefault(),e(this).parent().trigger("finishEdit",[!0]),!1}return!0}).blur(function(){var t=e(this);l=window.setTimeout(function(){t.parent().trigger("finishEdit",[!0])},500)})}}function a(i){i.trigger("finishEdit",[!0]).addClass("tagedit-listelement-deleted").attr("title",t.deletedElementTitle),i.find(":hidden").each(function(){var i=new RegExp("("+t.addedPostfix+"|"+t.deletedPostfix+")?]"),a=e(this).attr("name").replace(i,t.deletedPostfix+"]");e(this).attr("name",a)})}function n(i,a){a=void 0!==a&&a;var n=null,s=1==t.checkNewEntriesCaseSensitive?i:i.toLowerCase(),r=!0;if(l.find("li.tagedit-listelement-old input:hidden").each(function(){(1==t.checkNewEntriesCaseSensitive?e(this).val():e(this).val().toLowerCase())==s&&(r=!1)}),1==r&&1==a&&0!=t.autocompleteOptions.source){var o=[];if(e.isArray(t.autocompleteOptions.source))o=t.autocompleteOptions.source;else if(e.isFunction(t.autocompleteOptions.source))t.autocompleteOptions.source({term:i},function(e){o=e});else if("string"==typeof t.autocompleteOptions.source){var d=t.autocompleteOptions.source;d.match(/\?/)?d+="&":d+="?",d+="term="+i,e.ajax({async:!1,url:d,dataType:"json",complete:function(t,i){o=e.parseJSON(t.responseText)}})}for(var c=0;c<o.length;c++){var u=o[c].label?o[c].label:o[c];if((1==t.checkNewEntriesCaseSensitive?u:u.toLowerCase())==s){r=!1,n="string"==typeof o[c]?c:o[c].id;break}}}return new Array(r,n)}if(t=e.extend(!0,{autocompleteURL:null,checkToDeleteURL:null,deletedPostfix:"-d",addedPostfix:"-a",additionalListClass:"",allowEdit:!0,allowDelete:!0,allowAdd:!0,direction:"ltr",animSpeed:500,autocompleteOptions:{select:function(t,i){return e(this).val(i.item.value).trigger("transformToTag",[i.item.id]),!1}},breakKeyCodes:[13,44],checkNewEntriesCaseSensitive:!1,texts:{removeLinkTitle:"Remove from list.",saveEditLinkTitle:"Save changes.",deleteLinkTitle:"Delete this tag from database.",deleteConfirmation:"Are you sure to delete this entry?",deletedElementTitle:"This Element will be deleted.",breakEditLinkTitle:"Cancel",forceDeleteConfirmation:"There are more records using this tag, are you sure do you want to remove it?"}},t||{}),0!=this.length){t.autocompleteURL&&(t.autocompleteOptions.source=t.autocompleteURL);var s=this.attr("dir");s&&s.length>0&&(t.direction=this.attr("dir"));var l=this,r=new RegExp("^(.*)\\[([0-9]*?("+t.deletedPostfix+"|"+t.addedPostfix+")?)?]$","i"),o=l.eq(0).attr("name").match(r);o&&4==o.length?(o=o[1],function(){var s='<ul class="tagedit-list '+t.additionalListClass+'">';l.each(function(){var i=e(this).attr("name").match(r);if(i&&4==i.length&&(0==t.deleteEmptyItems||e(this).val().length>0)&&i[1].length>0){var a=void 0!==i[2]?i[2]:"";s+='<li class="tagedit-listelement tagedit-listelement-old">',s+='<span dir="'+t.direction+'">'+e(this).val()+"</span>",s+='<input type="hidden" name="'+o+"["+a+']" value="'+e(this).val()+'"/>',s+='<a class="tagedit-close" title="'+t.texts.removeLinkTitle+'">x</a>',s+="</li>"}}),l.last().after(s);var d=l.last().next();l.remove(),l=d,t.deletedPostfix.length>0&&l.find('input[name$="'+t.deletedPostfix+']"]').each(function(){a(e(this).parent())}),s='<li class="tagedit-listelement tagedit-listelement-new">',s+='<input type="text" name="'+o+'[]" value="" id="tagedit-input" disabled="disabled" class="tagedit-input-disabled" dir="'+t.direction+'"/>',s+="</li>",s+="</ul>",l.append(s).find("#tagedit-input").each(function(){e(this).autoGrowInput({comfortZone:15,minWidth:15,maxWidth:2e4}),e(this).bind("transformToTag",function(i,a){var l=void 0!==a&&(a.length>0||a>0),r=1!=l,d=n(e(this).val(),r);if((!0===d[0]||!1===d[0]&&"string"==typeof d[1])&&(0==l&&"string"==typeof d[1]&&(l=!0,a=d[1]),1==t.allowAdd||l)){s='<li class="tagedit-listelement tagedit-listelement-old">',s+='<span dir="'+t.direction+'">'+e(this).val()+"</span>";var c=l?o+"["+a+t.addedPostfix+"]":o+"[]";s+='<input type="hidden" name="'+c+'" value="'+e(this).val()+'" />',s+='<a class="tagedit-close" title="'+t.texts.removeLinkTitle+'">x</a>',s+="</li>",e(this).parent().before(s)}e(this).val(""),t.autocompleteOptions.source&&e(this).autocomplete("close")}).keydown(function(i){switch(i.keyCode>0?i.keyCode:i.which){case 8:if(0==e(this).val().length){var a=l.find("li.tagedit-listelement-old").last();return a.fadeOut(t.animSpeed,function(){a.remove()}),i.preventDefault(),!1}break;case 9:if(e(this).val().length>0&&0==e("ul.ui-autocomplete #ui-active-menuitem").length)return e(this).trigger("transformToTag"),i.preventDefault(),!1}return!0}).keypress(function(i){var a=i.keyCode>0?i.keyCode:i.which;return!(e.inArray(a,t.breakKeyCodes)>-1&&(e(this).val().length>0&&0==e("ul.ui-autocomplete #ui-active-menuitem").length&&e(this).trigger("transformToTag"),i.preventDefault(),1))}).bind("paste",function(t){var i=e(this);"paste"==t.type&&setTimeout(function(){i.trigger("transformToTag")},1)}).blur(function(){if(0==e(this).val().length)e(this).attr("disabled","disabled").addClass("tagedit-input-disabled");else{var t=e(this);e(this).data("blurtimer",window.setTimeout(function(){t.val("")},500))}}).focus(function(){window.clearTimeout(e(this).data("blurtimer"))}),0!=t.autocompleteOptions.source&&e(this).autocomplete(t.autocompleteOptions)}).end().click(function(a){switch(a.target.tagName){case"A":e(a.target).parent().fadeOut(t.animSpeed,function(){e(a.target).parent().remove()});break;case"INPUT":case"SPAN":case"LI":if(0==e(a.target).hasClass("tagedit-listelement-deleted")&&0==e(a.target).parent("li").hasClass("tagedit-listelement-deleted"))return i(a);default:e(this).find("#tagedit-input").removeAttr("disabled").removeClass("tagedit-input-disabled").focus()}return!1})}()):alert("elementname dows not match the expected format (regexp: "+r+")")}}}(jQuery);