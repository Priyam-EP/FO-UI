!function(e,t,n){var a={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},i={triggerChar:"@",onDataRequest:e.noop,minChars:2,showAvatars:!0,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img  src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%= value %></span></strong>")}},o={htmlEncode:function(e){return t.escape(e)},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}};e.fn.mentionsInput=function(n,l){"object"!=typeof n&&n||(l=e.extend(!0,{},i,n));var r=arguments;return this.each(function(){var i=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new function(n){function i(){var e=r();t.each(A,function(t){var n=f.templates.mentionItemSyntax({value:t.value,type:t.type,id:t.id});e=e.replace(t.value,n)});var n=o.htmlEncode(e);t.each(A,function(e){var t=f.templates.mentionItemSyntax({value:o.htmlEncode(e.value),type:e.type,id:e.id}),a=f.templates.mentionItemHighlight({value:o.htmlEncode(e.value)});n=n.replace(t,a)}),n=n.replace(/\n/g,"<br />"),n=n.replace(/ {2}/g,"&nbsp; "),g.data("messageText",e),E.find("div").html(n)}function l(){b=[]}function r(){return e.trim(g.val())}function s(t){var n=e(this);return function(e,t,n){var a=r(),s=new RegExp("\\"+f.triggerChar+x,"gi");s.exec(a);var c=s.lastIndex-x.length-1,u=s.lastIndex,p=a.substr(0,c),m=a.substr(u,a.length),v=(p+e).length,h=p+e+m;A.push({id:t,type:n,value:e}),l(),x="",d(),g.val(h),i(),g.focus(),o.setCaratPosition(g[0],v)}(n.attr("data-display"),n.attr("data-ref-id"),n.attr("data-ref-type")),!1}function c(e){l()}function u(e){i(),function(){var e=r();A=t.reject(A,function(t,n){return!t.value||-1==e.indexOf(t.value)}),A=t.compact(A)}(),d();var n=t.lastIndexOf(b,f.triggerChar);n>-1&&(x=b.slice(n+1).join(""),x=o.rtrim(x),t.defer(t.bind(h,this,x)))}function p(e){var t=String.fromCharCode(e.which||e.keyCode);b.push(t)}function m(n){if(n.keyCode!=a.LEFT&&n.keyCode!=a.RIGHT&&n.keyCode!=a.HOME&&n.keyCode!=a.END){if(n.keyCode!=a.BACKSPACE){if(!C.is(":visible"))return!0;switch(n.keyCode){case a.UP:case a.DOWN:var i=null;return(i=n.keyCode==a.DOWN?T&&T.length?T.next():C.find("li").first():e(T).prev()).length&&v(i),!1;case a.RETURN:case a.TAB:if(T&&T.length)return T.click(),!1}return!0}b=b.slice(0,-1+b.length)}else t.defer(l)}function d(){T=null,C.empty().hide()}function v(e){e.addClass(f.classes.autoCompleteItemActive),e.siblings().removeClass(f.classes.autoCompleteItemActive),T=e}function h(n){n&&n.length&&n.length>=f.minChars&&f.onDataRequest.call(this,"search",n,function(a){!function(n,a){C.show();var i=t.pluck(A,"value");if((a=t.reject(a,function(e){return t.include(i,e.name)})).length){C.empty();var l=e("<ul>").appendTo(C).hide();t.each(a,function(t,a){var i=e(f.templates.autocompleteListItem({id:o.htmlEncode(t.id),display:o.htmlEncode(t.name),type:o.htmlEncode(t.type),content:o.highlightTerm(o.htmlEncode(t.name),n)}));0===a&&v(i),f.showAvatars&&e(t.avatar?f.templates.autocompleteListItemAvatar({avatar:t.avatar}):f.templates.autocompleteListItemIcon({icon:t.icon})).prependTo(i),i=i.appendTo(l)}),C.show(),l.show()}else d()}(n,a)})}var f,g,y,C,I,E,T,x,A=[],b=[];return{init:function(t){f=t,"true"!=(g=e(n)).attr("data-mentions-input")&&(y=g.parent(),I=e(f.templates.wrapper()),g.wrapAll(I),I=y.find("> div"),g.attr("data-mentions-input","true"),g.bind("keydown",m),g.bind("keypress",p),g.bind("input",u),g.bind("click",c),g.elastic()),(C=e(f.templates.autocompleteList())).appendTo(I),C.delegate("li","click",s),(E=e(f.templates.mentionsOverlay())).prependTo(I)},val:function(e){if(t.isFunction(e)){var n=A.length?g.data("messageText"):r();e.call(this,n)}},reset:function(){g.val(""),A=[],i()},getMentions:function(e){t.isFunction(e)&&e.call(this,A)}}}(this));return t.isFunction(i[n])?i[n].apply(this,Array.prototype.slice.call(r,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):i.init.call(this,l)})}}(jQuery,_);