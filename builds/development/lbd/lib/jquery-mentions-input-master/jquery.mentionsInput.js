!function(x,A,e){var b={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},i={triggerChar:"@",onDataRequest:x.noop,minChars:2,showAvatars:!0,classes:{autoCompleteItemActive:"active"},templates:{wrapper:A.template('<div class="mentions-input-box"></div>'),autocompleteList:A.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:A.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:A.template('<img  src="<%= avatar %>" />'),autocompleteListItemIcon:A.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:A.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:A.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:A.template("<strong><span><%= value %></span></strong>")}},k={htmlEncode:function(e){return A.escape(e)},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},o=function(t){var p,m,n,o,a,i,l,d,v=[],r=[];function h(){var n=g();A.each(v,function(e){var t=p.templates.mentionItemSyntax({value:e.value,type:e.type,id:e.id});n=n.replace(e.value,t)});var a=k.htmlEncode(n);A.each(v,function(e){var t=p.templates.mentionItemSyntax({value:k.htmlEncode(e.value),type:e.type,id:e.id}),n=p.templates.mentionItemHighlight({value:k.htmlEncode(e.value)});a=a.replace(t,n)}),a=(a=a.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),m.data("messageText",n),i.find("div").html(a)}function f(){r=[]}function g(){return x.trim(m.val())}function s(e){var t=x(this);return function(e,t,n){var a=g(),i=new RegExp("\\"+p.triggerChar+d,"gi");i.exec(a);var o=i.lastIndex-d.length-1,l=i.lastIndex,r=a.substr(0,o),s=a.substr(l,a.length),c=(r+e).length,u=r+e+s;v.push({id:t,type:n,value:e}),f(),d="",I(),m.val(u),h(),m.focus(),k.setCaratPosition(m[0],c)}(t.attr("data-display"),t.attr("data-ref-id"),t.attr("data-ref-type")),!1}function c(e){f()}function u(e){var n;h(),n=g(),v=A.reject(v,function(e,t){return!e.value||-1==n.indexOf(e.value)}),v=A.compact(v),I();var t=A.lastIndexOf(r,p.triggerChar);-1<t&&(d=r.slice(t+1).join(""),d=k.rtrim(d),A.defer(A.bind(T,this,d)))}function y(e){var t=String.fromCharCode(e.which||e.keyCode);r.push(t)}function C(e){if(e.keyCode!=b.LEFT&&e.keyCode!=b.RIGHT&&e.keyCode!=b.HOME&&e.keyCode!=b.END){if(e.keyCode!=b.BACKSPACE){if(!o.is(":visible"))return!0;switch(e.keyCode){case b.UP:case b.DOWN:var t=null;return(t=e.keyCode==b.DOWN?l&&l.length?l.next():o.find("li").first():x(l).prev()).length&&E(t),!1;case b.RETURN:case b.TAB:if(l&&l.length)return l.click(),!1}return!0}r=r.slice(0,-1+r.length)}else A.defer(f)}function I(){l=null,o.empty().hide()}function E(e){e.addClass(p.classes.autoCompleteItemActive),e.siblings().removeClass(p.classes.autoCompleteItemActive),l=e}function T(t){t&&t.length&&t.length>=p.minChars&&p.onDataRequest.call(this,"search",t,function(e){!function(a,e){o.show();var t=A.pluck(v,"value");if((e=A.reject(e,function(e){return A.include(t,e.name)})).length){o.empty();var i=x("<ul>").appendTo(o).hide();A.each(e,function(e,t){var n=x(p.templates.autocompleteListItem({id:k.htmlEncode(e.id),display:k.htmlEncode(e.name),type:k.htmlEncode(e.type),content:k.highlightTerm(k.htmlEncode(e.name),a)}));0===t&&E(n),p.showAvatars&&(e.avatar?x(p.templates.autocompleteListItemAvatar({avatar:e.avatar})):x(p.templates.autocompleteListItemIcon({icon:e.icon}))).prependTo(n),n=n.appendTo(i)}),o.show(),i.show()}else I()}(t,e)})}return{init:function(e){p=e,"true"!=(m=x(t)).attr("data-mentions-input")&&(n=m.parent(),a=x(p.templates.wrapper()),m.wrapAll(a),a=n.find("> div"),m.attr("data-mentions-input","true"),m.bind("keydown",C),m.bind("keypress",y),m.bind("input",u),m.bind("click",c),m.elastic()),(o=x(p.templates.autocompleteList())).appendTo(a),o.delegate("li","click",s),(i=x(p.templates.mentionsOverlay())).prependTo(a)},val:function(e){if(A.isFunction(e)){var t=v.length?m.data("messageText"):g();e.call(this,t)}},reset:function(){m.val(""),v=[],h()},getMentions:function(e){A.isFunction(e)&&e.call(this,v)}}};x.fn.mentionsInput=function(t,n){"object"!=typeof t&&t||(n=x.extend(!0,{},i,t));var a=arguments;return this.each(function(){var e=x.data(this,"mentionsInput")||x.data(this,"mentionsInput",new o(this));return A.isFunction(e[t])?e[t].apply(this,Array.prototype.slice.call(a,1)):"object"!=typeof t&&t?void x.error("Method "+t+" does not exist"):e.init.call(this,n)})}}(jQuery,_);