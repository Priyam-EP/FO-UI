!function(e,t,n){var a={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},o={defaultValue1:"",triggerChar:"#",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li datas-ref-id="<%= id %>" datas-ref-type="<%= type %>" datas-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("[<%=value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%=value %></span></strong>")}},r={htmlEncode:function(e){return t.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}};e.fn.hashInput=function(n,s){var l=arguments;return"object"!=typeof n&&n||(s=n),this.each(function(){var c=e.data(this,"hashInput")||e.data(this,"hashInput",new function(n){function s(){var e=d();t.each(k,function(t){var i=n.templates.mentionItemSyntax(t);e=e.replace(new RegExp(r.regexpEncode(t.value),"g"),i)});var i=e;t.each(k,function(e){var a=t.extend({},e,{value:e.value}),o=n.templates.mentionItemSyntax(a),s=n.templates.mentionItemHighlight(a);i=i.replace(new RegExp(r.regexpEncode(o),"g"),s)}),i=i.replace(/\n/g,"<br />"),i=i.replace(/ {2}/g,"&nbsp; "),T.data("messageText",e),T.trigger("updated"),A.find("div").html(i)}function l(){M=[]}function c(e){for(var i=d(),a=T[0].selectionStart,o=!1,c=!1,p=new RegExp("\\"+n.triggerChar+O,"gi");p.exec(i);)(!1===o||Math.abs(p.lastIndex-a)<o)&&(o=Math.abs(p.lastIndex-a),c=p.lastIndex);var u=c-O.length-1,f=c,h=i.substr(0,u),g=i.substr(f,i.length),m=(h+e.value).length+1;t.find(k,function(t){return t.id==e.id})||k.push(e),l(),O="",v();var x=h+n.triggerChar+e.value+" "+g;T.val(x),T.trigger("mention"),s(),T.focus(),r.setCaratPosition(T[0],m)}function d(){return e.trim(T.val())}function p(t){var n=e(this);return c(L[n.attr("datas-uid")]),function(){var t=e(T).offset().top,n=e("body").offset().top;e(window).scrollTop()>t&&e(window).scrollTop(t-n)}(),!1}function u(e){l();var a=this.selectionStart,o=d().substring(" ",a),r=o.substring(o.lastIndexOf(" ")+1).toLowerCase();if(r.charAt(0)===n.triggerChar){var s=r;for(i=0;i<s.length;i++)M.push(s[i]);t.defer(t.bind(w,this,s))}}function f(e){v()}function h(e){s(),function(){var e=d();k=t.reject(k,function(t,n){return!t.value||-1==e.indexOf(t.value)}),k=t.compact(k)}();var i=t.lastIndexOf(M,n.triggerChar);i>-1&&(O=M.slice(i+1).join(""),O=r.rtrim(O),t.defer(t.bind(w,this,O)))}function g(e){if(e.keyCode!==a.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);M.push(t)}}function m(n){if(n.keyCode===a.LEFT||n.keyCode===a.RIGHT||n.keyCode===a.HOME||n.keyCode===a.END)return t.defer(l),void(navigator.userAgent.indexOf("MSIE 9")>-1&&t.defer(s));if(n.keyCode!==a.BACKSPACE){if(!I.is(":visible"))return!0;switch(n.keyCode){case a.DOWN:var i=null;return(i=n.keyCode===a.DOWN?R&&R.length?R.next():I.find("li").first():e(R).prev()).length&&x(i),!1;case a.RETURN:case a.TAB:if(R&&R.length)return R.trigger("mousedown"),!1}return!0}M=M.slice(0,-1+M.length)}function v(){R=null,I.empty().hide()}function x(e){e.addClass(n.classes.autoCompleteItemActive),e.siblings().removeClass(n.classes.autoCompleteItemActive),R=e}function b(i,a){if(I.show(),!n.allowRepeat){var o=t.pluck(k,"value");a=t.reject(a,function(e){return t.include(o,e.name)})}if(a.length){I.empty();var s=e("<ul>").appendTo(I).hide();t.each(a,function(a,o){var l=t.uniqueId("mention_");L[l]=t.extend({},a,{value:a.name});var c=e(n.templates.autocompleteListItem({id:a.id,display:a.name,type:a.type,content:r.highlightTerm(a.display?a.display:a.name,i)})).attr("datas-uid",l);0===o&&x(c),n.showAvatars&&e(a.avatar?n.templates.autocompleteListItemAvatar({avatar:a.avatar}):n.templates.autocompleteListItemIcon({icon:a.icon})).prependTo(c),c=c.appendTo(s)}),I.show(),n.onCaret&&function(t,n){var i=t.css("position");if("absolute"==i){var a=function(t){var i,a,o,r,s,l,c,d,p,u,f;if((p=n[0])&&e(p).is("textarea")&&null!=p.selectionEnd){for(c={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},u=0,f=(d=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;u<f;u++)s=d[u],c[s]=e(p).css(s);return o=document.createElement("div"),e(o).css(c),e(p).after(o),a=document.createTextNode(p.value.substring(0,p.selectionEnd)),i=document.createTextNode(p.value.substring(p.selectionEnd)),r=document.createElement("span"),r.innerHTML="&nbsp;",o.appendChild(a),o.appendChild(r),o.appendChild(i),o.scrollTop=p.scrollTop,l=e(r).position(),e(o).remove(),l}}(),o=parseInt(n.css("line-height"),10)||18;t.css("width","15em"),t.css("left",a.left),t.css("top",o+a.top);var r=n.offset().left+n.width(),s=t.offset().left+t.width();r<=s&&t.css("left",Math.abs(t.position().left-(s-r)))}else if("fixed"==i){var l=function(t){var i,a,o,r,s,l,c,d,p,u,f;if((p=n[0])&&e(p).is("textarea")&&null!=p.selectionEnd){for(c={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},u=0,f=(d=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;u<f;u++)s=d[u],c[s]=e(p).css(s);return o=document.createElement("div"),e(o).css(c),e(p).after(o),a=document.createTextNode(p.value.substring(0,p.selectionEnd)),i=document.createTextNode(p.value.substring(p.selectionEnd)),r=document.createElement("span"),r.innerHTML="&nbsp;",o.appendChild(a),o.appendChild(r),o.appendChild(i),o.scrollTop=p.scrollTop,l=e(r).offset(),e(o).remove(),l}}(),o=parseInt(n.css("line-height"),10)||18;t.css("width","15em"),t.css("left",l.left+1e4),t.css("top",o+l.top)}}(I,T),s.show()}else v()}function w(e){e&&e.length&&e.length>=n.minChars?n.onDataRequest.call(this,"search",e,function(t){b(e,t)}):v()}function C(e){k=[];for(var t,i=e,a=new RegExp("("+n.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),o=i;null!=(t=a.exec(i));)o=o.replace(t[0],t[1]+t[2]),k.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});T.val(o),s()}var y,T,E,I,S,A,R,k=[],L={},M=[],O="";return n=e.extend(!0,{},o,n),{init:function(t){"true"!==(T=e(y=t)).attr("datas-mentions-input")&&(E=T.parent(),S=e(n.templates.wrapper()),T.wrapAll(S),S=E.find("> div.mentions-input-box"),T.attr("datas-mentions-input","true"),T.bind("keydown",m),T.bind("keypress",g),T.bind("click",u),T.bind("blur",f),navigator.userAgent.indexOf("MSIE 8")>-1?T.bind("propertychange",h):T.bind("input",h),n.elastic&&T.elastic()),(I=e(n.templates.autocompleteList())).appendTo(S),I.delegate("li","mousedown",p),(A=e(n.templates.mentionsOverlay())).prependTo(S),C(n.defaultValue),n.prefillMention&&c(n.prefillMention)},val:function(e){t.isFunction(e)&&e.call(this,k.length?T.data("messageText"):d())},reset:function(){C()},reinit:function(){C(!1)},getMentions:function(e){t.isFunction(e)&&e.call(this,k)}}}(s));return t.isFunction(c[n])?c[n].apply(this,Array.prototype.slice.call(l,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):c.init.call(this,this)})}}(jQuery,_);