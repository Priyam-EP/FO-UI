!function(R,k,e){var L={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},M={defaultValue1:"",triggerChar:"#",onDataRequest:R.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:k.template('<div class="mentions-input-box"></div>'),autocompleteList:k.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:k.template('<li datas-ref-id="<%= id %>" datas-ref-type="<%= type %>" datas-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:k.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:k.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:k.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:k.template("[<%=value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:k.template("<strong><span><%=value %></span></strong>")}},O={htmlEncode:function(e){return k.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},a=function(u){var f,t,n,a,o,r,h=[],s={},l=[],g="";function m(){var n=x();k.each(h,function(e){var t=u.templates.mentionItemSyntax(e);n=n.replace(new RegExp(O.regexpEncode(e.value),"g"),t)});var a=n;k.each(h,function(e){var t=k.extend({},e,{value:e.value}),n=u.templates.mentionItemSyntax(t),i=u.templates.mentionItemHighlight(t);a=a.replace(new RegExp(O.regexpEncode(n),"g"),i)}),a=(a=a.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),f.data("messageText",n),f.trigger("updated"),o.find("div").html(a)}function v(){l=[]}function c(t){for(var e=x(),n=f[0].selectionStart,i=!1,a=!1,o=new RegExp("\\"+u.triggerChar+g,"gi");o.exec(e);)(!1===i||Math.abs(o.lastIndex-n)<i)&&(i=Math.abs(o.lastIndex-n),a=o.lastIndex);var r=a-g.length-1,s=a,l=e.substr(0,r),c=e.substr(s,e.length),d=(l+t.value).length+1;k.find(h,function(e){return e.id==t.id})||h.push(t),v(),g="",T();var p=l+u.triggerChar+t.value+" "+c;f.val(p),f.trigger("mention"),m(),f.focus(),O.setCaratPosition(f[0],d)}function x(){return R.trim(f.val())}function d(e){var t,n,i=R(this);return c(s[i.attr("datas-uid")]),t=R(f).offset().top,n=R("body").offset().top,t<R(window).scrollTop()&&R(window).scrollTop(t-n),!1}function p(e){v();var t=this.selectionStart,n=x().substring(" ",t),a=n.substring(n.lastIndexOf(" ")+1).toLowerCase();if(a.charAt(0)===u.triggerChar){var o=a;for(i=0;i<o.length;i++)l.push(o[i]);k.defer(k.bind(S,this,o))}}function b(e){T()}function w(e){var n;m(),n=x(),h=k.reject(h,function(e,t){return!e.value||-1==n.indexOf(e.value)}),h=k.compact(h);var t=k.lastIndexOf(l,u.triggerChar);-1<t&&(g=l.slice(t+1).join(""),g=O.rtrim(g),k.defer(k.bind(S,this,g)))}function C(e){if(e.keyCode!==L.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);l.push(t)}}function y(e){if(e.keyCode===L.LEFT||e.keyCode===L.RIGHT||e.keyCode===L.HOME||e.keyCode===L.END)return k.defer(v),void(-1<navigator.userAgent.indexOf("MSIE 9")&&k.defer(m));if(e.keyCode!==L.BACKSPACE){if(!n.is(":visible"))return!0;switch(e.keyCode){case L.DOWN:var t=null;return(t=e.keyCode===L.DOWN?r&&r.length?r.next():n.find("li").first():R(r).prev()).length&&E(t),!1;case L.RETURN:case L.TAB:if(r&&r.length)return r.trigger("mousedown"),!1}return!0}l=l.slice(0,-1+l.length)}function T(){r=null,n.empty().hide()}function E(e){e.addClass(u.classes.autoCompleteItemActive),e.siblings().removeClass(u.classes.autoCompleteItemActive),r=e}function I(a,e){if(n.show(),!u.allowRepeat){var t=k.pluck(h,"value");e=k.reject(e,function(e){return k.include(t,e.name)})}if(e.length){n.empty();var o=R("<ul>").appendTo(n).hide();k.each(e,function(e,t){var n=k.uniqueId("mention_");s[n]=k.extend({},e,{value:e.name});var i=R(u.templates.autocompleteListItem({id:e.id,display:e.name,type:e.type,content:O.highlightTerm(e.display?e.display:e.name,a)})).attr("datas-uid",n);(0===t&&E(i),u.showAvatars)&&(e.avatar?R(u.templates.autocompleteListItemAvatar({avatar:e.avatar})):R(u.templates.autocompleteListItemIcon({icon:e.icon}))).prependTo(i);i=i.appendTo(o)}),n.show(),u.onCaret&&function(e,t){var n=e.css("position");if("absolute"==n){var i=function(e){var t,n,i,a,o,r,s,l,c,d,p;if((c=e[0])&&R(c).is("textarea")&&null!=c.selectionEnd){for(s={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},d=0,p=(l=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;d<p;d++)s[o=l[d]]=R(c).css(o);return i=document.createElement("div"),R(i).css(s),R(c).after(i),n=document.createTextNode(c.value.substring(0,c.selectionEnd)),t=document.createTextNode(c.value.substring(c.selectionEnd)),(a=document.createElement("span")).innerHTML="&nbsp;",i.appendChild(n),i.appendChild(a),i.appendChild(t),i.scrollTop=c.scrollTop,r=R(a).position(),R(i).remove(),r}}(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",i.left),e.css("top",a+i.top);var o=t.offset().left+t.width(),r=e.offset().left+e.width();o<=r&&e.css("left",Math.abs(e.position().left-(r-o)))}else if("fixed"==n){var s=function(e){var t,n,i,a,o,r,s,l,c,d,p;if((c=e[0])&&R(c).is("textarea")&&null!=c.selectionEnd){for(s={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},d=0,p=(l=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;d<p;d++)s[o=l[d]]=R(c).css(o);return i=document.createElement("div"),R(i).css(s),R(c).after(i),n=document.createTextNode(c.value.substring(0,c.selectionEnd)),t=document.createTextNode(c.value.substring(c.selectionEnd)),(a=document.createElement("span")).innerHTML="&nbsp;",i.appendChild(n),i.appendChild(a),i.appendChild(t),i.scrollTop=c.scrollTop,r=R(a).offset(),R(i).remove(),r}}(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",s.left+1e4),e.css("top",a+s.top)}}(n,f),o.show()}else T()}function S(t){t&&t.length&&t.length>=u.minChars?u.onDataRequest.call(this,"search",t,function(e){I(t,e)}):T()}function A(e){h=[];for(var t,n=e,i=new RegExp("("+u.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),a=n;null!=(t=i.exec(n));)a=a.replace(t[0],t[1]+t[2]),h.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});f.val(a),m()}return u=R.extend(!0,{},M,u),{init:function(e){"true"!==(f=R(e)).attr("datas-mentions-input")&&(t=f.parent(),a=R(u.templates.wrapper()),f.wrapAll(a),a=t.find("> div.mentions-input-box"),f.attr("datas-mentions-input","true"),f.bind("keydown",y),f.bind("keypress",C),f.bind("click",p),f.bind("blur",b),-1<navigator.userAgent.indexOf("MSIE 8")?f.bind("propertychange",w):f.bind("input",w),u.elastic&&f.elastic()),(n=R(u.templates.autocompleteList())).appendTo(a),n.delegate("li","mousedown",d),(o=R(u.templates.mentionsOverlay())).prependTo(a),A(u.defaultValue),u.prefillMention&&c(u.prefillMention)},val:function(e){k.isFunction(e)&&e.call(this,h.length?f.data("messageText"):x())},reset:function(){A()},reinit:function(){A(!1)},getMentions:function(e){k.isFunction(e)&&e.call(this,h)}}};R.fn.hashInput=function(t,n){var i=arguments;return"object"!=typeof t&&t||(n=t),this.each(function(){var e=R.data(this,"hashInput")||R.data(this,"hashInput",new a(n));return k.isFunction(e[t])?e[t].apply(this,Array.prototype.slice.call(i,1)):"object"!=typeof t&&t?void R.error("Method "+t+" does not exist"):e.init.call(this,this)})}}(jQuery,_);